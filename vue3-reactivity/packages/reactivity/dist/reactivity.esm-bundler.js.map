{"version":3,"file":"reactivity.esm-bundler.js","sources":["../../shared/src/index.ts","../src/baseHandlers.ts","../src/reactive.ts"],"sourcesContent":["/*\r\n * @Author: 李思豪\r\n * @Date: 2022-06-23 11:05:10\r\n * @LastEditTime: 2022-07-19 14:53:47\r\n * @Description: file content\r\n * @LastEditors: 李思豪\r\n */\r\n\r\nexport const _isObject = (value) => typeof value == 'object' && value !== null;\r\n\r\nexport const _extend = Object.assign\r\n\r\nexport const _isArray = Array.isArray\r\n\r\nexport const _isIntegerKey = (key) => parseInt(key) + '' === key\r\n\r\nlet hasOwnpRroperty = Object.prototype.hasOwnProperty;\r\nexport const _hasOwn = (target, key) => hasOwnpRroperty.call(target, key);\r\n\r\nexport const _hasChanged =(oldValue,value) => oldValue !== value","/*\r\n* @Author: 李思豪\r\n* @Date: 2022-07-13 16:07:17\r\n * @LastEditTime: 2022-07-19 15:03:22\r\n* @Description: file content\r\n * @LastEditors: 李思豪\r\n*/\r\nimport { _extend, _hasChanged, _hasOwn, _isArray, _isIntegerKey, _isObject } from \"@vue/shared\"\r\nimport { reactive, readonly } from \"./reactive\";\r\n\r\nfunction createGetter(isReadonly = false, shallow = false){\r\n  /**\r\n   * @param target 是原来的对象\r\n   * @param key 去取什么属性\r\n   * @param receiver 代理对象\r\n   */\r\n  return function get(target, key, receiver){\r\n    // Reflect 就是后续慢慢替换掉 Object 对象, 一般是会用 proxy 会配合 Reflect\r\n    // target[key] === Reflect.get(target, key, receiver)\r\n    const res = Reflect.get(target, key, receiver)\r\n    if(shallow) return res;\r\n    if(!readonly){\r\n      console.log('收集当前属性, 如果属性变化了, 稍后可能要更新视图')\r\n    }\r\n    if(_isObject(res)){ // 懒递归, 当我们取值的时候才去做 递归代理, 如果不取默认值代理一层\r\n      return isReadonly ? readonly(res) : reactive(res)\r\n    }\r\n    return res\r\n  }\r\n  // vue3 针对的是对象来进行劫持, 不用改写原来的对象, 如果是嵌套, 当取值的时候才会代理\r\n  // vue2 针对的是属性劫持, 改写了原来对象, 一上来就递归的。\r\n  // vue3 可以对不存在的属性进行获取, 也会走 get 方法, proxy 支持数组。\r\n} \r\n\r\n// 设置属性, 可能是新增属性, 还有可能是修改属性值\r\nfunction createSetter(shallow = false){\r\n  // 针对数组而言, 如果调用 push 方法, 就会产生 2 次触发\r\n  // 1. 给数组新增了一项，同时也更改了长度\r\n  // 2. 因为更改了长度再次触发 set (第二次触发是无意义的)\r\n  return function set(target, key, value, receiver){\r\n    const oldValue = target[key]\r\n    console.log(target, key, value, receiver)\r\n    // 判断数组是新增还是修改\r\n    console.log(_isIntegerKey(key))\r\n    \r\n    let hadKey = _isArray(target) && _isIntegerKey(key) ? Number(key) < target.length : _hasOwn(target, key)\r\n    // 先判断有没有，再去设置值\r\n    const res = Reflect.set(target, key, value, receiver)\r\n    if(!hadKey){\r\n      console.log('新增')\r\n    }else if(_hasChanged(oldValue, value)){\r\n      console.log('修改')\r\n    }\r\n    return res\r\n  }\r\n}\r\n\r\nconst get = createGetter()\r\nconst shallowGet = createGetter(false,true)\r\nconst readonlyGet = createGetter(true)\r\nconst shallowReadonlyGet = createGetter(true,true)\r\n\r\nconst set = createSetter()\r\nconst shallowSet = createSetter(true)\r\n\r\nexport const mutableHandler = {\r\n  get,\r\n  set,\r\n}\r\nexport const shallowReactiveHandlers = {\r\n  get:shallowGet,\r\n  set:shallowSet\r\n}\r\n\r\nlet readonlySet = {\r\n  set(target, key){\r\n    console.warn(`cannot set ${JSON.stringify(target)} on key ${key} falied`)\r\n  }\r\n}\r\n\r\nexport const readonlyHandlers = _extend({\r\n    get:readonlyGet\r\n},readonlySet)\r\n\r\nexport const shallowReadonlyHanlders = _extend({\r\n  get:shallowReadonlyGet\r\n},readonlySet)\r\n\r\n","/*\r\n * @Author: 李思豪\r\n * @Date: 2022-06-24 14:58:48\r\n * @LastEditTime: 2022-07-19 14:28:56\r\n * @Description: file content\r\n * @LastEditors: 李思豪\r\n */\r\n\r\nimport { _isObject } from '@vue/shared';\r\nimport { mutableHandler, readonlyHandlers, shallowReactiveHandlers, shallowReadonlyHanlders} from './baseHandlers'\r\n\r\n/**\r\n * @param target\r\n */\r\nexport function reactive(target) {\r\n  return createReactiveObject(target, false, mutableHandler);\r\n}\r\nexport function shallowReactive(target) {\r\n return createReactiveObject(target, false, shallowReactiveHandlers);\r\n}\r\nexport function readonly(target) {\r\n return createReactiveObject(target, true, readonlyHandlers);\r\n}\r\nexport function shallowReadonly(target) {\r\n return createReactiveObject(target, true, shallowReadonlyHanlders);\r\n}\r\n\r\n/**\r\n * @param target 创建代理的目标\r\n * @param isReadonly 当前是不是仅读的\r\n * @param baseHandler 针对不同的方式创建不同的代理对象\r\n */\r\nconst reactiveMap = new WeakMap()\r\nconst readonlyMap = new WeakMap()\r\nfunction createReactiveObject(target, isReadonly, baseHandler) {\r\n  if (!_isObject(target)) target;\r\n  const proxyMap = isReadonly ? readonlyMap : reactiveMap\r\n  const exisProxy = proxyMap.get(target)\r\n  if(exisProxy) exisProxy\r\n  const proxy = new Proxy(target, baseHandler);\r\n  proxyMap.set(target, proxy)\r\n  return proxy;\r\n}\r\n\r\n"],"names":[],"mappings":"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"}